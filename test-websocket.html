<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.0/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .section {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .log {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>WebSocket Test for Dezhou Poker</h1>
    
    <div class="container">
        <div class="section">
            <h2>Connection Status</h2>
            <div id="status" class="status disconnected">Disconnected</div>
            <button id="connectBtn">Connect</button>
            <button id="disconnectBtn" disabled>Disconnect</button>
        </div>

        <div class="section">
            <h2>Test Messages</h2>
            <button id="sendTestBtn" disabled>Send Test Message</button>
            <button id="sendEchoBtn" disabled>Send Echo Message</button>
        </div>

        <div class="section">
            <h2>Game Room Subscription</h2>
            <div>
                <input type="text" id="roomIdInput" placeholder="Enter room ID" value="1">
                <button id="subscribeBtn" disabled>Subscribe to Room</button>
                <button id="unsubscribeBtn" disabled>Unsubscribe</button>
            </div>
        </div>

        <div class="section">
            <h2>Log</h2>
            <div id="log" class="log"></div>
            <button onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <script>
        // Configuration
        const wsBaseURL = 'http://localhost:8080';
        const wsEndpoint = `${wsBaseURL}/ws`;

        // DOM elements
        const statusElement = document.getElementById('status');
        const logElement = document.getElementById('log');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const sendTestBtn = document.getElementById('sendTestBtn');
        const sendEchoBtn = document.getElementById('sendEchoBtn');
        const subscribeBtn = document.getElementById('subscribeBtn');
        const unsubscribeBtn = document.getElementById('unsubscribeBtn');
        const roomIdInput = document.getElementById('roomIdInput');

        // WebSocket variables
        let stompClient = null;
        let subscription = null;

        // Log function
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            logElement.innerHTML = '';
        }

        // Update UI based on connection state
        function updateUI() {
            const isConnected = stompClient !== null && stompClient.connected;
            
            if (isConnected) {
                statusElement.textContent = 'Connected';
                statusElement.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendTestBtn.disabled = false;
                sendEchoBtn.disabled = false;
                subscribeBtn.disabled = false;
            } else {
                statusElement.textContent = 'Disconnected';
                statusElement.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                sendTestBtn.disabled = true;
                sendEchoBtn.disabled = true;
                subscribeBtn.disabled = true;
            }
        }

        // Connect to WebSocket
        function connect() {
            log('Connecting to WebSocket...');
            
            const socket = new SockJS(wsEndpoint);
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                log('Connected: ' + frame);
                updateUI();
            }, function(error) {
                log('Connection error: ' + error);
                stompClient = null;
                updateUI();
            });
        }

        // Disconnect from WebSocket
        function disconnect() {
            if (stompClient && stompClient.connected) {
                if (subscription) {
                    subscription.unsubscribe();
                    subscription = null;
                    unsubscribeBtn.disabled = true;
                }
                
                stompClient.disconnect(function() {
                    log('Disconnected');
                    stompClient = null;
                    updateUI();
                });
            }
        }

        // Send test message
        function sendTestMessage() {
            if (stompClient && stompClient.connected) {
                const message = {
                    type: 'TEST',
                    eventType: 'TEST_MESSAGE',
                    data: {
                        content: 'Hello WebSocket!',
                        timestamp: new Date().toISOString()
                    }
                };
                
                stompClient.send('/app/test.message', {}, JSON.stringify(message));
                log('Sent test message');
            }
        }

        // Send echo message
        function sendEchoMessage() {
            if (stompClient && stompClient.connected) {
                const message = 'Hello Echo! ' + new Date().toLocaleTimeString();
                stompClient.send('/app/echo', {}, message);
                log('Sent echo message: ' + message);
            }
        }

        // Subscribe to game room
        function subscribeToGameRoom() {
            const roomId = roomIdInput.value.trim();
            if (!roomId) {
                log('Please enter a room ID');
                return;
            }
            
            if (subscription) {
                subscription.unsubscribe();
            }
            
            const destination = `/topic/game.${roomId}.events`;
            subscription = stompClient.subscribe(destination, function(message) {
                const parsedMessage = JSON.parse(message.body);
                log(`Game Room ${roomId} Event: ${parsedMessage.eventType}`);
                log(`Data: ${JSON.stringify(parsedMessage.data)}`);
            });
            
            log(`Subscribed to game room ${roomId} events`);
            unsubscribeBtn.disabled = false;
        }

        // Unsubscribe from game room
        function unsubscribe() {
            if (subscription) {
                subscription.unsubscribe();
                subscription = null;
                log('Unsubscribed from game room');
                unsubscribeBtn.disabled = true;
            }
        }

        // Event listeners
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        sendTestBtn.addEventListener('click', sendTestMessage);
        sendEchoBtn.addEventListener('click', sendEchoMessage);
        subscribeBtn.addEventListener('click', subscribeToGameRoom);
        unsubscribeBtn.addEventListener('click', unsubscribe);

        // Initialize
        log('WebSocket Test Ready');
        updateUI();
    </script>
</body>
</html>